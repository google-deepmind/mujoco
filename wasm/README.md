# MuJoCo WASM

> [!IMPORTANT]
> These WASM bindings are still a WIP. While the main MuJoCo APIs (`mj_step`, `mj_loadXML` etc) are
> complete and well tested, others are untested in real web applications (most notably functions
> from `mjspec.h`). Also be aware that some of the bindings code is manually written (eventually
> everything will be automatically generated) and that development has been targetting linux, so if
> you're work on platforms like MacOS or Windows then there may be some rough edges. Community
> contributions/improvements are very welcome!

## Prerequisites

> [!TIP]
> Windows users: Consider using a Git Bash terminal.

- In order to compile the `bindings.cc` file which generates the `.wasm` web-assembly file, `.js` JavaScript import and `.d.ts` TypeScript declaration file) you will need:
    - A C++ compiler supporting C++20.
    - A version of `cmake` meeting the version requirement in the top level CMakeLists.txt file.
    - Emscripten SDK version `4.0.10`. Later versions do not work yet, read [this](https://github.com/ekumenlabs/mujoco_internal/pull/44#issuecomment-3339343789) for more details. Download the SDK [here](https://emscripten.org/docs/getting_started/downloads.html) then follow thse steps:

      ```sh
      git clone https://github.com/emscripten-core/emsdk.git
      cd emsdk
      ./emsdk install 4.0.10
      ./emsdk activate 4.0.10
      source ./emsdk_env.sh
      ```

- The `bindings.cc` file is autogenerated using Python. To change the bindings you will need `python3`, `pytest` will also be helpful to run the bindings generator tests.

- In order to easily run the JavaScript/TypeScript tests and the demo applications `node` and `npm` are required, we recommend using [nvm](https://github.com/nvm-sh/nvm) to manage these. There are also various JavaScript/TypeScript dependencies for the various targets: test suite, demo apps and bindings build process. The should be installed as follows:

  ```sh
  # Run this inside `wasm` folder
  npm install
  ```

## Bindings generation

> [!IMPORTANT]
> Make sure to run the following steps in the same terminal session in which the `emsdk` environment was sourced.

The following script will use MuJoCo's python introspect library to generate a C++ file with the relevant Embind `EMSCRIPTEN_BINDINGS` block which is used to bind C++ functions and classes to Javascript. The script generates wrapper functions around MuJoCo's C API which provide a place for adding conveniences like bounds checking.

```sh
# Run this inside `wasm` folder
PYTHONPATH=../python/mujoco:./codegen python3 codegen/update.py

# Run this inside `wasm` folder
PYTHONPATH=../python/mujoco:../wasm python3 tests/enums_test_generator.py && \

# Runs files of the form test_*.py or *_test.py in the current directory recursively
PYTHONPATH=../python/mujoco:./codegen python3 -m pytest
```

Once the C++ files are generated (note that for convenience we provide the output of the above script in the `wasm/codegen/generated` folder already) the next step is to build the `.wasm`, `.js`, and `.d.ts` files from the C++ files (which are the files you will call MuJoCo from JavaScript/TypeScript). To do this run the following:

> [!TIP]
> Before running these make sure no `build` and `dist` folder exist in the root of the project or inside `wasm` folder.

```sh
# Run this inside `wasm` folder
WASM_DIR=$(pwd) && PROJECT_ROOT=$(dirname "$WASM_DIR") && \
export PATH="${WASM_DIR}/node_modules/.bin:$PATH" && \
emcmake cmake -S "$PROJECT_ROOT" -B "$PROJECT_ROOT/build" && cmake --build "$PROJECT_ROOT/build" && \
emcmake cmake -S "$WASM_DIR" -B "$WASM_DIR/build" && cmake --build "$WASM_DIR/build"
```

This will generate a few folders:
- `<project-root>/build` is the result of compiling MuJoCo with emscripten.
- `<project-root>/wasm/build` is the result of compiling MuJoCo bindings with emscripten.
- `<project-root>/wasm/dist` is MuJoCo WebAssembly module. To use it, the file you need to import here is the one ended in `.js`.

## Tests

The test suite will run three kind of tests:

1. Enums bindings: assess all MuJoCo enums are declared.
2. Function bindings: verifies a wide variety of MuJoCo functions and classes work correctly when called from Javascript.
3. Benchmarks: measures shared memory buffer management approaches.

Run the following commands (the benchmark bindings code is compilied first):
```sh
# Run this inside `wasm` folder
WASM_DIR=$(pwd) && \
export PATH="${WASM_DIR}/node_modules/.bin:$PATH" && \
emcmake cmake -S "$WASM_DIR/tests" -B "$WASM_DIR/tests/build" && \
cmake --build "$WASM_DIR/tests/build" && \
npm run test
```

## Give it a try

- To run the demo app use `npm run dev:demo`. This is a use case scenario with a small ThreeJS app using MuJoCo WASM module.
- To run the sandbox app use `npm run dev:sandbox`. This is a playground app meant for you to experiment any MuJoCo functionality you want in the browser.
