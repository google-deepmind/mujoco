# MuJoCo WASM

> [!IMPORTANT]
> These WASM bindings are still a WIP. While the main MuJoCo APIs (`mj_step`, `mj_loadXML` etc) are
> complete and well tested, others are untested in real web applications (most notably functions
> from `mjspec.h`). Also be aware that some of the bindings code is manually written (eventually
> everything will be automatically generated) and that development has been targetting linux. If
> you're work on platforms like MacOS or Windows then there may be some rough edges. Community
> contributions/improvements are very welcome!

## Prerequisites

- In order to compile the `bindings.cc` file which generates the `.wasm` web-assembly file, `.js` JavaScript import and `.d.ts` TypeScript declaration file) you will need the Emscripten SDK version `4.0.10`. Later versions do not work yet, read [this](https://github.com/ekumenlabs/mujoco_internal/pull/44#issuecomment-3339343789) for more details. Download the SDK [here](https://emscripten.org/docs/getting_started/downloads.html) then follow these steps:

  ```sh
  git clone https://github.com/emscripten-core/emsdk.git
  cd emsdk
  ./emsdk install 4.0.10
  ./emsdk activate 4.0.10
  source ./emsdk_env.sh
  ```

- In order to easily run the JavaScript/TypeScript tests and the demo applications `node` and `npm` are required. We recommend managing this using [nvm](https://github.com/nvm-sh/nvm). There are also various JavaScript/TypeScript dependencies needed for the test suite, demo apps and bindings build process, these dependencies are currently expected to be installed in the `wasm` folder as follows:

  ```sh
  # Run this inside `wasm` folder
  npm install
  ```

- In order to modify the bindings `python3` is required since the `bindings.cc` file is (mostly) autogenerated with Python. In order to run the bindings generator tests `pytest` will also be helpful.


## Bindings generation

The following script will use MuJoCo's python introspect library to generate a C++ file with the relevant Embind `EMSCRIPTEN_BINDINGS` block which is used to bind C++ functions and classes to Javascript. The script generates wrapper functions around MuJoCo's C API which provide a place for adding conveniences like bounds checking.

```sh
# Run this inside `wasm` folder
PYTHONPATH=../python/mujoco:./codegen python3 codegen/update.py
```

Once the C++ files are generated (note that for convenience we provide the output of the above script in the `wasm/codegen/generated` folder already) the next step is to build the `.wasm`, `.js`, and `.d.ts` files from the C++ files (which are the files you will call MuJoCo from JavaScript/TypeScript). Make sure you have set up the npm and Emscripten SDK prequisites then run the following (in the same terminal session where `emsdk` environment was sourced):

> [!NOTE]
> Make sure to run the following steps in the same terminal session in which the Emscripen SDK was sourced, also make sure no `build` and `dist` folder exist in the root of the project or inside `wasm` folder.

```sh
# Run this inside `wasm` folder
WASM_DIR=$(pwd) && PROJECT_ROOT=$(dirname "$WASM_DIR") && \
export PATH="${WASM_DIR}/node_modules/.bin:$PATH" && \
emcmake cmake -S "$PROJECT_ROOT" -B "$PROJECT_ROOT/build" && \
cmake --build "$PROJECT_ROOT/build" && \
emcmake cmake -S "$WASM_DIR" -B "$WASM_DIR/build" && \
cmake --build "$WASM_DIR/build"
```

The above command will generate the following folders:

- `<project-root>/build` is the result of compiling MuJoCo with emscripten.
- `<project-root>/wasm/build` is the result of compiling MuJoCo bindings with emscripten.
- `<project-root>/wasm/dist` is MuJoCo WebAssembly module. To use it you need to import the `.js` file.


## TypeScript demo app

- To run the demo app use `npm run dev:demo`. This is a use case scenario with a small ThreeJS app using MuJoCo WASM module.

We plan to extend this demo into a simple application which can be used to build paper project pages.  Future work will likely provide an example using the new filament rendering and toolbox components.


## Tests

There are two three of tests:

1. JavaScript/TypeScript API tests. verifies a wide variety of MuJoCo functions and classes work correctly when called from Javascript, there are also some preliminary benchmarks for shared memory buffers.  Run the following commands (the benchmark bindings code is compilied first):

   ```sh
   # Run this inside `wasm` folder
   WASM_DIR=$(pwd) && \
   export PATH="${WASM_DIR}/node_modules/.bin:$PATH" && \
   emcmake cmake -S "$WASM_DIR/tests" -B "$WASM_DIR/tests/build" && \
   cmake --build "$WASM_DIR/tests/build" && \
   npm run test
   ```

2. JS/TS sandbox test app. Use `npm run dev:sandbox`. This is a playground app meant for you to experiment any MuJoCo functionality you want in the browser.

3. Bindings Generator tests. These are relevant when developing/extending the bindings. The enums test is special since its auto-generated to cover all enums in the API.

   ```sh
   # Run this inside `wasm` folder
   PYTHONPATH=../python/mujoco:../wasm python3 tests/enums_test_generator.py && \

   # Runs files of the form test_*.py or *_test.py in the current directory recursively
   PYTHONPATH=../python/mujoco:./codegen python3 -m pytest
   ```

